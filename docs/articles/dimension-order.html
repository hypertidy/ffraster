<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grids and dimension order in R • ffraster</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">ffraster</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Grids and dimension order in R</h1>
                        <h4 class="author">Michael D. Sumner</h4>
            
            <h4 class="date">2017-06-15</h4>
          </div>

    
    
<div class="contents">
<p>R uses <em>column-major order</em> for matrices and <a href="https://cran.r-project.org/web/packages/reticulate/vignettes/arrays.html" title="Array order discussed in reticulate">arrays</a>.</p>
<p>This is a simple rule to remember, but there are several rather subtle implications with how this relates to other conventions.</p>
<p>Consider the numbers <code>1:24</code> as a one-dimensional reference point, a basis from which we understand several contexts.</p>
<p>Create the data as 32-bit integers (4 bytes each).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d24 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">24</span></code></pre></div>
<p>Create colours as a matching property for each individual value of data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cols &lt;-<span class="st"> </span>viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="kw">length</span>(d24))

## worker function to drive image as I wish it were
mimage &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">label  =</span> <span class="ot">TRUE</span>, ...) {
  <span class="kw">UseMethod</span>(<span class="st">"mimage"</span>)
}
mimage.matrix &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">label =</span> <span class="ot">TRUE</span>, cols, ...) {
  mat &lt;-<span class="st"> </span>x
  x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(mat))
  y &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">ncol</span>(mat))
  <span class="kw">image</span>(x, y, mat, <span class="dt">col =</span> cols)
}
mimage.array &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">label =</span> <span class="ot">TRUE</span>, ...) {
  dn &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">dim</span>(x))
  <span class="cf">if</span> (dn <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span> <span class="op">|</span><span class="st"> </span>dn <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>) {
    <span class="kw">warning</span>(<span class="st">"we expect a matrix or 3D array but dim(x):"</span>)
    <span class="kw">print</span>(<span class="kw">dim</span>(x))
  }
  <span class="kw">on.exit</span>(<span class="kw">par</span>(p), <span class="dt">add =</span> <span class="ot">TRUE</span>)
  p &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> grDevices<span class="op">::</span><span class="kw">n2mfrow</span>(<span class="kw">dim</span>(x)[<span class="dv">3</span>]))
  xx &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(x))
  yy &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">ncol</span>(x))
  xy &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">x =</span> <span class="kw">head</span>(xx, <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, 
                    <span class="dt">y =</span> <span class="kw">head</span>(yy, <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>)
  
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">dim</span>(x)[<span class="dv">3</span>])) {
    <span class="kw">mimage</span>(x[,,i, <span class="dt">drop =</span> <span class="ot">TRUE</span>], <span class="dt">cols =</span> cols[(<span class="dv">1</span><span class="op">:</span><span class="dv">12</span>) <span class="op">+</span><span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span>(i<span class="op">-</span><span class="dv">1</span>)])
  <span class="cf">if</span> (label) <span class="kw">text</span>(xy<span class="op">$</span>x, xy<span class="op">$</span>y, <span class="dt">label =</span> <span class="kw">seq_len</span>(<span class="kw">nrow</span>(xy)) <span class="op">+</span><span class="st"> </span><span class="kw">nrow</span>(xy) <span class="op">*</span><span class="st"> </span>(i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))

}
}</code></pre></div>
<div id="rs-matrix-and-array" class="section level2">
<h2 class="hasAnchor">
<a href="#rs-matrix-and-array" class="anchor"></a>R’s matrix and array</h2>
<p>Generate a matrix from the data, here the rows of the matrix go down the page and columns go from left to right.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">matrix</span>(d24)</code></pre></div>
<pre><code>##       [,1]
##  [1,]    1
##  [2,]    2
##  [3,]    3
##  [4,]    4
##  [5,]    5
##  [6,]    6
##  [7,]    7
##  [8,]    8
##  [9,]    9
## [10,]   10
## [11,]   11
## [12,]   12
## [13,]   13
## [14,]   14
## [15,]   15
## [16,]   16
## [17,]   17
## [18,]   18
## [19,]   19
## [20,]   20
## [21,]   21
## [22,]   22
## [23,]   23
## [24,]   24</code></pre>
<p>Consecutive elements in the data occur next to each other in the column, this is what column-major means. Now if we provide a set of <em>dimensions</em> longer than 1 we see more clearly how the data populate down the rows, then to the side by columns, and finally by row then column in the next slice of this 3D array.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="kw">array</span>(d24, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>))
a</code></pre></div>
<pre><code>## , , 1
## 
##      [,1] [,2] [,3] [,4]
## [1,]    1    4    7   10
## [2,]    2    5    8   11
## [3,]    3    6    9   12
## 
## , , 2
## 
##      [,1] [,2] [,3] [,4]
## [1,]   13   16   19   22
## [2,]   14   17   20   23
## [3,]   15   18   21   24</code></pre>
<p>It’s convenient in R that we can think about rows runing “down the page”, then columns that are “left to right” - but we then run out of dimensions so “into the page” has to be pulled out and becomes a new step below the first run of rows. What if we represent the matrix as a raster image.</p>
<p>Again we have to put the second slice of the third dimension “down the page” because we don’t have a 3D visualization device. (Hold that thought. )</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mimage</span>(a)</code></pre></div>
<p><img src="dimension-order_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>What is happening here? The colours start dark and get lighter, so why do we see that pattern go up and then down, things aren’t lining up. To be sure, let’s also plot the colours very directly in order 1, 24 to make sure we can think about the order properly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(d24, <span class="dt">col =</span> cols, <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">cex =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="dimension-order_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>There are two problems with our expection here. One problem is that we are used to running “down the page”, both when we fill the matrix with numbers and when we print subsequent slices from a 3D array. This conflicts with another expectation we have, which is that in a Cartesian frame we have an X-axis that starts with low numbers on the left and runs to higher numbers on the right, and a Y-axis that starts at the bottom and runs “up the page”. (We can see that here in the numbers on the axis increasing left to right and bottom to top).</p>
<p>The second problem is that running down the rows is now going left to right in the image, so we are going left to right then up, left to right, then up, … then, we flip one entire page down below where we started and left to right, up again, … etc.</p>
<p>This is confusing! The important thing to remember is how the data looks when we print it in the console, and where the numbers go next when the first slice is finished, because this corresponds with the order of the extraction index syntax in R:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a[, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span>]</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    4
## [2,]    2    5
## [3,]    3    6</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a[, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">2</span>]</code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]   13   16
## [2,]   14   17
## [3,]   15   18</code></pre>
<p>It’s also important to note that we effortlessly are juggling these explicit and implicit coordinate systems all the time, when we make plots, read text on a page, interpret data structures, and interrogate models by various means.</p>
</div>
<div id="geographic-raster" class="section level1">
<h1 class="hasAnchor">
<a href="#geographic-raster" class="anchor"></a>Geographic raster</h1>
<p>The raster package uses the other convention when plotting a raster, in <em>row-major</em> form. To see this in action we turn our array into a RasterBrick.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(raster)</code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw">setExtent</span>(<span class="kw">brick</span>(a, <span class="dt">transpose =</span> <span class="ot">TRUE</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">nrow</span>(a), <span class="dv">0</span>, <span class="kw">ncol</span>(a)))
p &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> grDevices<span class="op">::</span><span class="kw">n2mfrow</span>(<span class="kw">nlayers</span>(b)))
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">nlayers</span>(b))) {
  <span class="kw">plot</span>(b[[i]], <span class="dt">col =</span> cols, <span class="dt">breaks =</span> d24, <span class="dt">zlim =</span> <span class="kw">cellStats</span>(b[[i]], range), <span class="dt">asp =</span> <span class="st">""</span>)
  <span class="kw">text</span>(<span class="kw">coordinates</span>(b), <span class="dt">lab =</span> d24[(<span class="dv">1</span><span class="op">:</span><span class="dv">12</span>) <span class="op">+</span><span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span>(i<span class="op">-</span><span class="dv">1</span>)])
}</code></pre></div>
<p><img src="dimension-order_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>Notice the <code>transpose=TRUE</code> which is the right way to have an R matrix converted into the raster orientation. It’s also true that the intention might be very different, but it can be very confusing with a symmetric data set like this. It’s best to have a unambiguously identifiable orientation in the data (like a map) to confirm that we are getting what we need.</p>
</div>
<div id="internal-storage-of-data-in-raster" class="section level1">
<h1 class="hasAnchor">
<a href="#internal-storage-of-data-in-raster" class="anchor"></a>Internal storage of data in raster</h1>
<p>When we generated the array of data, we put the values in in order <code>1:24</code> and we made an image that showed us reading left to right and up the page - arguably this is the “right” way, but a more common convention used in image graphics and in many spatial software packages is in the western world reading convention, left to right and from top to bottom.</p>
<p>This is what the raster brick looks like under the hood.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">values</span>(b)</code></pre></div>
<pre><code>##       layer.1 layer.2
##  [1,]       1      13
##  [2,]       2      14
##  [3,]       3      15
##  [4,]       4      16
##  [5,]       5      17
##  [6,]       6      18
##  [7,]       7      19
##  [8,]       8      20
##  [9,]       9      21
## [10,]      10      22
## [11,]      11      23
## [12,]      12      24</code></pre>
<p>This finally is very easy to understand. Note that we had to use <code>transpose = TRUE</code>, but now the order of the values down the rows is the order of the pixels in the plot above from left to right and down.</p>
<p>The way to think about each ‘layer’ is as the “flattened” version seen in each column here. That is literally how data is stored within raster, whenever it is in memory. It is referred to as “BSQ” or “band-sequential”. This means that a ‘layer’ or a slice in our 3D array is a band, and that all its values are stored <strong><em>in an R matrix using column-major convention</em></strong>.</p>
<p>So it’s still confusing, we are already juggling several conventions and coordinate systems. But, raster is so powerful and so capable of reading, writing, manipulating and converting data in many ways that it’s well worthwhile to take on board how these conventions work.</p>
<p>The fact that the cell number runs from top left to right and down <em>in order</em> is also very convenient, since many data extraction, matching and grouping routines can rely on this convention for very efficient processing.</p>
</div>
<div id="band-order-in-raster-native--grd-format" class="section level1">
<h1 class="hasAnchor">
<a href="#band-order-in-raster-native--grd-format" class="anchor"></a>Band order in raster native .grd format</h1>
<p>When we write out raster data in native format there is a default setting of <code>bandorder</code> to be BIL, or band-interleaved.</p>
<p>These are exactly the same, the files will be identical.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">file0 &lt;-<span class="st"> </span><span class="kw">rasterTmpFile</span>()
file1 &lt;-<span class="st"> </span><span class="kw">rasterTmpFile</span>()
b0 &lt;-<span class="st"> </span><span class="kw">writeRaster</span>(b, file0, <span class="dt">datatype =</span> <span class="st">"FLT4S"</span>)

b1 &lt;-<span class="st"> </span><span class="kw">writeRaster</span>(b, file1, <span class="dt">bandorder =</span> <span class="st">"BIL"</span>)

rb &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="kw">readBin</span>(x,<span class="st">"raw"</span>, <span class="dt">n=</span> <span class="kw">file.info</span>(x)<span class="op">$</span>size)
}
<span class="kw">identical</span>(digest<span class="op">::</span><span class="kw">digest</span>(<span class="kw">rb</span>(file0)), 
          digest<span class="op">::</span><span class="kw">digest</span>(<span class="kw">rb</span>(file1)))</code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>So, our data is stored in BSQ in-memory but the default when we write it out is to convert it to BIL. When we read that BIL or BSQ version in from file, it will be BSQ.</p>
<p>Again this is confusing but it’s because tasks that are common to multi-layered data are more efficient - specifically extracting a time-series pixel in one location is most efficient in BIL, because only one read operation is required to get all of the data.</p>
<div id="ff-can-map-these-raw-binary-files" class="section level2">
<h2 class="hasAnchor">
<a href="#ff-can-map-these-raw-binary-files" class="anchor"></a>ff can “map” these raw binary files</h2>
<p>In very raw form, without any safety checks or generalizations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## something is wrong...
<span class="kw">library</span>(ff)
b0_ff &lt;-<span class="st"> </span><span class="kw">ff</span>(<span class="dt">filename =</span> file0, <span class="dt">vmode =</span> <span class="st">"single"</span>, <span class="dt">dim =</span> <span class="kw">dim</span>(b0), <span class="dt">readonly =</span> <span class="ot">TRUE</span>  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ffraster)
ff_b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ff_object.html">ff_object</a></span>(<span class="kw">brick</span>(file0))
ff<span class="op">::</span><span class="kw">as.ram</span>(ff_b)</code></pre></div>
<pre><code>## , , 1
## 
##      [,1] [,2] [,3]
## [1,]    1    2    3
## [2,]    4    5    6
## [3,]    7    8    9
## [4,]   10   11   12
## 
## , , 2
## 
##      [,1] [,2] [,3]
## [1,]   13   14   15
## [2,]   16   17   18
## [3,]   19   20   21
## [4,]   22   23   24
## 
## attr(,"physical")
## (hidden, use physical(x) to access the physical attributes and vmode(x) for accessing vmode)
## attr(,"virtual")
## (hidden, use virtual(x) to access the virtual attributes)
## attr(,"vmode")
##    FLT4S 
## "single"</code></pre>
<p>TBD we need dimorder sorted for detection from raster .grd before proceeding</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#rs-matrix-and-array">R’s matrix and array</a></li>
      <li><a href="#geographic-raster">Geographic raster</a></li>
      <li><a href="#internal-storage-of-data-in-raster">Internal storage of data in raster</a></li>
      <li>
<a href="#band-order-in-raster-native-.grd-format">Band order in raster native .grd format</a><ul class="nav nav-pills nav-stacked">
<li><a href="#ff-can-map-these-raw-binary-files">ff can “map” these raw binary files</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael D. Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
